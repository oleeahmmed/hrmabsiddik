{% extends 'base.html' %}
{% load static %}

{% block title %}Project Report - {{ project.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.6.0/print.min.css">
<style>
    /* * IMPORTANT: This block defines styles for direct browser print (Ctrl+P).
     * The printReport() function uses its own style block for the printJS library, 
     * but keeping this here provides a robust fallback.
     */
    @media print {
        @page {
            size: A4 portrait; /* Changed to portrait */
            margin: 0.5cm;
        }
        
        body {
            /* Force exact colors and backgrounds for elements that must retain them (like KPI cards/badges) */
            print-color-adjust: exact !important;
            -webkit-print-color-adjust: exact !important;
            /* Removed white background enforcement to inherit global background (light gray) */
            color: black !important;
            font-size: 11pt;
            font-family: 'Arial', sans-serif;
        }
        
        .no-print {
            display: none !important;
        }
        
        .print-only {
            display: block !important;
        }
        
        /* General styling resets/fixes for print */
        /* Removed .bg-white enforcement */
        
        .border {
            border: 1px solid #ddd !important;
        }
        
        .shadow-sm {
            box-shadow: none !important;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 9pt;
            margin-top: 10px;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
        }
        
        th {
            background-color: #f8f9fa !important;
            font-weight: 600;
            color: #374151;
        }
        
        /* Force Grid Layouts to work */
        .grid {
            display: grid !important;
        }
        
        .grid-cols-4 {
            grid-template-columns: repeat(4, 1fr) !important;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr) !important;
        }
        
        .gap-4 {
            gap: 16px !important;
        }
        
        /* Force text/background colors for status badges and stats */
        .text-blue-600 { color: #2563eb !important; }
        .text-green-600 { color: #059669 !important; }
        .text-red-600 { color: #dc2626 !important; }
        .text-yellow-600 { color: #d97706 !important; }
        
        .bg-green-100 { background-color: #d1fae5 !important; }
        .bg-red-100 { background-color: #fee2e2 !important; }
        .bg-blue-100 { background-color: #dbeafe !important; }
        .bg-yellow-100 { background-color: #fef3c7 !important; }
        .bg-gray-200 { background-color: #e5e7eb !important; }
        .bg-green-600 { background-color: #059669 !important; }
        .bg-blue-600 { background-color: #2563eb !important; }
        /* New colors for stats inside table */
        .bg-blue-100 { background-color: #dbeafe !important; }
        .bg-blue-800 { color: #1e40af !important; }
        .bg-green-100 { background-color: #d1fae5 !important; }
        .bg-green-800 { color: #065f46 !important; }
        .bg-yellow-100 { background-color: #fef3c7 !important; }
        .bg-yellow-600 { color: #ca8a04 !important; }
        .bg-red-100 { background-color: #fee2e2 !important; }
        .bg-red-800 { color: #991b1b !important; }
        .bg-gray-50 { background-color: #f9fafb !important; }
        .border-blue-200 { border-color: #bfdbfe !important; }
        .border-green-200 { border-color: #a7f3d0 !important; }
        .border-yellow-200 { border-color: #fcd34d !important; }
        .border-red-200 { border-color: #fecaca !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6 no-print">
    <!-- Page Header (Non-printable button/title) -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Project Report</h1>
            <p class="text-gray-600 mt-1">Detailed project information and analytics</p>
        </div>
        <button onclick="printReport()" class="btn btn-primary flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
            </svg>
            Print Report (Tabular)
        </button>
    </div>
</div>

<!-- Printable Content - Tabular Format -->
<div id="printable-area">
    
    <!-- 1. Company and Project Header (BEFORE table) -->
    <div class="print-only hidden p-4 mb-6 text-center">
        <h1 class="text-2xl font-bold text-gray-900 mb-1">{{ project.company.name }}</h1>
        <h2 class="text-xl font-semibold text-gray-800">PROJECT REPORT: {{ project.name }}</h2>
        <p class="text-sm text-gray-600 mt-2">Generated on: {{ print_date|date:"F j, Y" }}</p>
    </div>

    <!-- 2. Main Tabular Report Body -->
    <div class="print-only hidden">
        <!-- Removed: <h4 class="text-lg font-semibold text-gray-800 px-4 pt-4">Project Summary & Details</h4> -->
        <table class="w-full">
            <!-- KEY METRICS / SINGLE STATE CARD AREA -->
            <!-- Removed: <thead> section for "Key Performance Indicators" -->
            <tbody>
                <tr>
                    <td colspan="2" class="p-0 border-none">
                        <div class="grid grid-cols-4 gap-4 p-4">
                            <!-- Stat 1: Total Tasks -->
                            <div class="bg-blue-100 border border-blue-200 p-3 text-center rounded-lg">
                                <div class="text-xl font-bold text-blue-800">{{ task_distribution.total }}</div>
                                <div class="text-xs font-medium text-blue-600 mt-1">Total Tasks</div>
                            </div>
                            <!-- Stat 2: Completed -->
                            <div class="bg-green-100 border border-green-200 p-3 text-center rounded-lg">
                                <div class="text-xl font-bold text-green-800">{{ task_distribution.completed }}</div>
                                <div class="text-xs font-medium text-green-600 mt-1">Completed</div>
                            </div>
                            <!-- Stat 3: In Progress -->
                            <div class="bg-yellow-100 border border-yellow-200 p-3 text-center rounded-lg">
                                <div class="text-xl font-bold text-yellow-600">{{ task_distribution.in_progress }}</div>
                                <div class="text-xs font-medium text-yellow-600 mt-1">In Progress</div>
                            </div>
                            <!-- Stat 4: Overdue -->
                            <div class="bg-red-100 border border-red-200 p-3 text-center rounded-lg">
                                <div class="text-xl font-bold text-red-800">{{ overdue_tasks }}</div>
                                <div class="text-xs font-medium text-red-600 mt-1">Overdue</div>
                            </div>
                        </div>
                    </td>
                </tr>
                
                <!-- PROJECT DETAILS -->
                <tr>
                    <td class="w-1/3 p-2 font-semibold bg-gray-50">Project Description</td>
                    <td class="p-2 text-sm text-gray-700 leading-relaxed">
                        {% if project.description %}
                            {{ project.description }}
                        {% else %}
                            <span class="text-gray-500 italic">No description available.</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="w-1/3 p-2 font-semibold bg-gray-50">Overall Progress</td>
                    <td class="p-2 text-sm">
                        <div class="flex justify-between items-center">
                            <div class="w-3/4 bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" style="width: {{ progress }}%"></div>
                            </div>
                            <span class="font-bold text-gray-900 ml-4">{{ progress }}%</span>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="w-1/3 p-2 font-semibold bg-gray-50">Total Hours Worked</td>
                    <td class="p-2 text-sm font-medium">{{ total_hours|floatformat:1 }} hrs</td>
                </tr>
                {% if project.total_budget %}
                <tr>
                    <td class="w-1/3 p-2 font-semibold bg-gray-50">Budget / Spent / Remaining</td>
                    <td class="p-2 text-sm">
                        <span class="font-medium text-gray-700">${{ project.total_budget }}</span> /
                        <span class="font-medium text-orange-600">${{ project.spent_budget }}</span> /
                        <span class="font-medium {% if budget_status.remaining >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            ${{ budget_status.remaining|default:0 }}
                        </span>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>

        <!-- RECENT TASKS TABLE -->
        <div class="p-4 pt-6">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">Recent Tasks Details (Max 10)</h4>
            {% if recent_tasks %}
            <table class="w-full">
                <thead>
                    <tr>
                        <th class="text-left p-2 font-semibold text-gray-700">Task Title</th>
                        <th class="text-left p-2 font-semibold text-gray-700">Assigned To</th>
                        <th class="text-left p-2 font-semibold text-gray-700">Status</th>
                        <th class="text-left p-2 font-semibold text-gray-700">Priority</th>
                        <th class="text-left p-2 font-semibold text-gray-700">Due Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in recent_tasks %}
                    <tr>
                        <td class="p-2 text-sm text-gray-700">{{ task.title }}</td>
                        <td class="p-2 text-sm text-gray-600">
                            {% if task.assigned_to %}
                                {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                            {% else %}
                                <span class="text-gray-400">Unassigned</span>
                            {% endif %}
                        </td>
                        <td class="p-2 text-sm">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium 
                                {% if task.status == 'completed' %}bg-green-100 text-green-800
                                {% elif task.status == 'in_progress' %}bg-blue-100 text-blue-800
                                {% elif task.status == 'on_hold' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ task.get_status_display }}
                            </span>
                        </td>
                        <td class="p-2 text-sm">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium 
                                {% if task.priority == 'high' or task.priority == 'critical' %}bg-red-100 text-red-800
                                {% elif task.priority == 'medium' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                {{ task.get_priority_display }}
                            </span>
                        </td>
                        <td class="p-2 text-sm text-gray-600">{{ task.due_date|date:"M d, Y" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-gray-500 text-center py-4">No recent tasks found for this project.</p>
            {% endif %}
        </div>
    </div>


</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/print-js/1.6.0/print.min.js"></script>

<script>
function printReport() {
    // Show all print-only elements
    document.querySelectorAll('.print-only').forEach(el => {
        el.classList.remove('hidden');
    });

    printJS({
        printable: 'printable-area',
        type: 'html',
        /* This style block ensures all Tailwind classes and colors are enforced during printing */
        style: `
            /* CRITICAL: Force exact colors and backgrounds to prevent loss of styling */
            @page { 
                size: A4 portrait; /* Orientation is PORTRAIT */
                margin: 0.5cm;
            }
            body { 
                print-color-adjust: exact !important;
                -webkit-print-color-adjust: exact !important;
                /* Inherit background from global style */
                color: black !important;
                font-family: 'Arial', sans-serif;
                font-size: 11pt;
                line-height: 1.4;
            }
            .print-only { 
                display: block !important; 
            }
            .no-print { 
                display: none !important; 
            }

            /* General container/structure styles */
            /* Removed .bg-white enforcement */
            .border { border: 1px solid #ddd !important; }
            .border-gray-200 { border-color: #e5e7eb !important; }
            .shadow-sm { box-shadow: none !important; }

            /* Table styles */
            table { 
                border-collapse: collapse; 
                width: 100%; 
                font-size: 9pt;
            }
            th, td { 
                border: 1px solid #ddd; 
                padding: 6px 8px; 
                text-align: left; 
            }
            /* Override border style for the consolidated stats row */
            .p-0.border-none {
                padding: 0 !important;
                border: none !important;
            }
            th { 
                background-color: #f8f9fa !important; /* Force header background */
                font-weight: 600;
                color: #374151;
            }

            /* Grid Layout Enforcement (CRITICAL FIX) */
            .grid { display: grid !important; }
            .grid-cols-4 { grid-template-columns: repeat(4, 1fr) !important; }
            .grid-cols-2 { grid-template-columns: repeat(2, 1fr) !important; }
            .gap-4 { gap: 16px !important; }

            /* Typography & Colors */
            .text-center { text-align: center !important; }
            .text-left { text-align: left !important; }
            .text-2xl { font-size: 24px !important; }
            .text-xl { font-size: 20px !important; }
            .text-lg { font-size: 18px !important; }
            .text-sm { font-size: 14px !important; }
            .text-xs { font-size: 12px !important; }
            .font-bold { font-weight: 700 !important; }
            .font-semibold { font-weight: 600 !important; }
            .font-medium { font-weight: 500 !important; }
            .leading-relaxed { line-height: 1.625 !important; }

            /* Color Enforcement for backgrounds and text */
            .text-blue-600 { color: #2563eb !important; }
            .text-green-600 { color: #059669 !important; }
            .text-red-600 { color: #dc2626 !important; }
            .text-yellow-600 { color: #d97706 !important; }
            .text-orange-600 { color: #ea580c !important; }
            
            .text-gray-600 { color: #6b7280 !important; }
            .text-gray-700 { color: #374151 !important; }
            .text-gray-800 { color: #1f2937 !important; }
            .text-gray-900 { color: #111827 !important; }
            
            /* Status/KPI Block Colors */
            .bg-blue-100 { background-color: #dbeafe !important; }
            .border-blue-200 { border-color: #bfdbfe !important; }
            .text-blue-800 { color: #1e40af !important; }
            .bg-green-100 { background-color: #d1fae5 !important; }
            .border-green-200 { border-color: #a7f3d0 !important; }
            .text-green-800 { color: #065f46 !important; }
            .bg-yellow-100 { background-color: #fef3c7 !important; }
            .border-yellow-200 { border-color: #fcd34d !important; }
            .text-yellow-600 { color: #ca8a04 !important; }
            .bg-red-100 { background-color: #fee2e2 !important; }
            .border-red-200 { border-color: #fecaca !important; }
            .text-red-800 { color: #991b1b !important; }
            
            .bg-gray-50 { background-color: #f9fafb !important; }
            .bg-gray-100 { background-color: #f3f4f6 !important; }
            .bg-gray-200 { background-color: #e5e7eb !important; }
            .bg-green-600 { background-color: #059669 !important; }

            /* Spacing and Layout */
            .p-0 { padding: 0 !important; }
            .p-2 { padding: 8px !important; }
            .p-3 { padding: 12px !important; }
            .p-4 { padding: 16px !important; }
            .px-2 { padding-left: 8px !important; padding-right: 8px !important; }
            .py-1 { padding-top: 4px !important; padding-bottom: 4px !important; }
            .pt-4 { padding-top: 16px !important; }
            .pt-6 { padding-top: 24px !important; }
            .pb-4 { padding-bottom: 16px !important; }
            .mb-1 { margin-bottom: 4px !important; }
            .mb-4 { margin-bottom: 16px !important; }
            .mb-6 { margin-bottom: 24px !important; }
            .mt-1 { margin-top: 4px !important; }
            .mt-2 { margin-top: 8px !important; }
            .mt-6 { margin-top: 24px !important; }
            .w-full { width: 100% !important; }
            .w-1\/3 { width: 33.333333% !important; }
            .w-3\/4 { width: 75% !important; }
            .h-2 { height: 8px !important; }
            .rounded-lg { border-radius: 8px !important; }
            .rounded-full { border-radius: 9999px !important; }
            .inline-flex { display: inline-flex !important; }
            .items-center { align-items: center !important; }
            .flex { display: flex !important; }
            .justify-between { justify-content: space-between !important; }
            .space-y-2 > * + * { margin-top: 8px !important; }
        `,
        scanStyles: false,
        onPrintDialogClose: function() {
            // Hide print-only elements after printing
            document.querySelectorAll('.print-only').forEach(el => {
                el.classList.add('hidden');
            });
        }
    });
}

// Add keyboard shortcut for printing (Ctrl + P)
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        printReport();
    }
});
</script>
{% endblock %}
