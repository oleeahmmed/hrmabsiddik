{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ title|default:"Device Management" }} - {{ block.super }}{% endblock %}
{% block page_title %}{{ title|default:"Device Management" }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Loading Overlay -->
    <div class="fixed inset-0 z-50 hidden items-center justify-center bg-background/80 backdrop-blur-sm" id="loading">
        <div class="rounded-lg border bg-card p-6 shadow-lg">
            <div class="flex items-center gap-4">
                <svg class="h-8 w-8 animate-spin text-primary" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                </svg>
                <div>
                    <div class="text-lg font-semibold text-card-foreground">Testing Connection...</div>
                    <div class="text-sm text-muted-foreground">Please wait while we verify device connectivity</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold tracking-tight text-foreground">{{ title|default:"Add Device" }}</h1>
            <p class="text-muted-foreground">
                {% if device %}
                    Update device configuration and connection settings
                {% else %}
                    Add a new ZKTeco device to your attendance system
                {% endif %}
            </p>
        </div>
        <div class="flex items-center gap-3">
            <a href="{% url 'zkteco:device_list' %}" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Back to Devices
            </a>
            {% if device %}
            <a href="{% url 'zkteco:device_detail' device.id %}" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
                View Details
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Device Status Card (if editing) -->
    {% if device %}
    <div class="bg-card rounded-lg border border-border p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="flex items-center justify-center w-12 h-12 rounded-lg {% if device.is_active %}bg-green-100 text-green-600 dark:bg-green-900/20 dark:text-green-400{% else %}bg-red-100 text-red-600 dark:bg-red-900/20 dark:text-red-400{% endif %}">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        {% if device.is_active %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        {% else %}
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        {% endif %}
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-card-foreground">{{ device.name }}</h3>
                    <p class="text-sm text-muted-foreground">
                        Status: 
                        <span class="{% if device.is_active %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %} font-medium">
                            {% if device.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                        {% if device.last_synced %}
                        â€¢ Last synced: {{ device.last_synced|date:"M d, Y H:i" }}
                        {% endif %}
                    </p>
                </div>
            </div>
            <button type="button" id="test-connection-btn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-3">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>
                </svg>
                Test Connection
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Main Form Card -->
    <div class="bg-card rounded-lg border border-border">
        <div class="p-6 border-b border-border">
            <h2 class="text-xl font-semibold text-card-foreground">Device Configuration</h2>
            <p class="text-sm text-muted-foreground mt-1">Configure device connection settings and basic information</p>
        </div>
        
        <form method="post" class="p-6 space-y-6" id="device-form">
            {% csrf_token %}
            
            <!-- Form Errors -->
            {% if form.non_field_errors %}
            <div class="bg-destructive/10 border border-destructive/20 rounded-lg p-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="font-medium text-destructive">Please correct the following errors:</h3>
                </div>
                <ul class="mt-2 text-sm text-destructive space-y-1">
                    {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Basic Information Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Device Name -->
                <div class="space-y-2">
                    <label for="{{ form.name.id_for_label }}" class="text-sm font-medium text-foreground">
                        {{ form.name.label }}
                        <span class="text-destructive">*</span>
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                            </svg>
                        </div>
                        <input type="text" 
                               name="{{ form.name.name }}" 
                               id="{{ form.name.id_for_label }}"
                               value="{{ form.name.value|default:'' }}"
                               class="flex h-10 w-full rounded-md border border-input bg-background pl-10 pr-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 {% if form.name.errors %}border-destructive focus-visible:ring-destructive{% endif %}"
                               placeholder="Enter device name (e.g., Main Entrance)"
                               required>
                    </div>
                    {% if form.name.errors %}
                    <p class="text-sm text-destructive">{{ form.name.errors.0 }}</p>
                    {% endif %}
                    {% if form.name.help_text %}
                    <p class="text-sm text-muted-foreground">{{ form.name.help_text }}</p>
                    {% endif %}
                </div>

                <!-- IP Address -->
                <div class="space-y-2">
                    <label for="{{ form.ip_address.id_for_label }}" class="text-sm font-medium text-foreground">
                        {{ form.ip_address.label }}
                        <span class="text-destructive">*</span>
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                            </svg>
                        </div>
                        <input type="text" 
                               name="{{ form.ip_address.name }}" 
                               id="{{ form.ip_address.id_for_label }}"
                               value="{{ form.ip_address.value|default:'' }}"
                               class="flex h-10 w-full rounded-md border border-input bg-background pl-10 pr-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 {% if form.ip_address.errors %}border-destructive focus-visible:ring-destructive{% endif %}"
                               placeholder="192.168.1.100"
                               pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                               title="Enter a valid IP address"
                               required>
                    </div>
                    {% if form.ip_address.errors %}
                    <p class="text-sm text-destructive">{{ form.ip_address.errors.0 }}</p>
                    {% endif %}
                    {% if form.ip_address.help_text %}
                    <p class="text-sm text-muted-foreground">{{ form.ip_address.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Port -->
                <div class="space-y-2">
                    <label for="{{ form.port.id_for_label }}" class="text-sm font-medium text-foreground">
                        {{ form.port.label }}
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </div>
                        <input type="number" 
                               name="{{ form.port.name }}" 
                               id="{{ form.port.id_for_label }}"
                               value="{{ form.port.value|default:'4370' }}"
                               class="flex h-10 w-full rounded-md border border-input bg-background pl-10 pr-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 {% if form.port.errors %}border-destructive focus-visible:ring-destructive{% endif %}"
                               min="1" 
                               max="65535"
                               placeholder="4370 (default)">
                    </div>
                    {% if form.port.errors %}
                    <p class="text-sm text-destructive">{{ form.port.errors.0 }}</p>
                    {% endif %}
                    {% if form.port.help_text %}
                    <p class="text-sm text-muted-foreground">{{ form.port.help_text }}</p>
                    {% endif %}
                </div>

                <!-- Password -->
                <div class="space-y-2">
                    <label for="{{ form.password.id_for_label }}" class="text-sm font-medium text-foreground">
                        {{ form.password.label }}
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                            </svg>
                        </div>
                        <input type="text" 
                               name="{{ form.password.name }}" 
                               id="{{ form.password.id_for_label }}"
                               value="{{ form.password.value|default:'' }}"
                               class="flex h-10 w-full rounded-md border border-input bg-background pl-10 pr-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 {% if form.password.errors %}border-destructive focus-visible:ring-destructive{% endif %}"
                               placeholder="Leave empty if no password (default: 0)"
                               autocomplete="new-password">
                    </div>
                    {% if form.password.errors %}
                    <p class="text-sm text-destructive">{{ form.password.errors.0 }}</p>
                    {% endif %}
                    {% if form.password.help_text %}
                    <p class="text-sm text-muted-foreground">{{ form.password.help_text }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Description -->
            <div class="space-y-2">
                <label for="{{ form.description.id_for_label }}" class="text-sm font-medium text-foreground">
                    {{ form.description.label }}
                </label>
                <textarea name="{{ form.description.name }}" 
                          id="{{ form.description.id_for_label }}"
                          rows="3"
                          class="flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 {% if form.description.errors %}border-destructive focus-visible:ring-destructive{% endif %}"
                          placeholder="Optional description about device location, purpose, etc.">{{ form.description.value|default:'' }}</textarea>
                {% if form.description.errors %}
                <p class="text-sm text-destructive">{{ form.description.errors.0 }}</p>
                {% endif %}
                {% if form.description.help_text %}
                <p class="text-sm text-muted-foreground">{{ form.description.help_text }}</p>
                {% endif %}
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-between pt-6 border-t border-border">
                <div class="flex items-center gap-2 text-sm text-muted-foreground">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Connection will be tested automatically after saving</span>
                </div>
                <div class="flex items-center gap-3">
                    <a href="{% url 'zkteco:device_list' %}" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                        Cancel
                    </a>
                    <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        {{ submit_text|default:"Save Device" }}
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Connection Test Results (Hidden by default) -->
    <div id="connection-result" class="hidden bg-card rounded-lg border border-border p-6">
        <div class="flex items-center gap-4">
            <div id="result-icon" class="flex items-center justify-center w-12 h-12 rounded-lg">
                <!-- Icon will be inserted by JavaScript -->
            </div>
            <div>
                <h3 id="result-title" class="text-lg font-semibold text-card-foreground"></h3>
                <p id="result-message" class="text-sm text-muted-foreground"></p>
                <div id="result-details" class="hidden mt-2 text-sm text-muted-foreground">
                    <!-- Device details will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('device-form');
    const loading = document.getElementById('loading');
    const testBtn = document.getElementById('test-connection-btn');
    const resultDiv = document.getElementById('connection-result');
    const resultIcon = document.getElementById('result-icon');
    const resultTitle = document.getElementById('result-title');
    const resultMessage = document.getElementById('result-message');
    const resultDetails = document.getElementById('result-details');

    // Form submission handler
    form.addEventListener('submit', function(e) {
        loading.classList.remove('hidden');
        loading.classList.add('flex');
    });

    // Test connection handler (for existing devices)
    if (testBtn) {
        testBtn.addEventListener('click', function() {
            const ipAddress = document.getElementById('{{ form.ip_address.id_for_label }}').value;
            const port = document.getElementById('{{ form.port.id_for_label }}').value || 4370;
            const password = document.getElementById('{{ form.password.id_for_label }}').value || 0;

            if (!ipAddress) {
                showToast('Please enter an IP address first', 'error');
                return;
            }

            testConnection(ipAddress, port, password);
        });
    }

    function testConnection(ip, port, password) {
        loading.classList.remove('hidden');
        loading.classList.add('flex');
        resultDiv.classList.add('hidden');

        fetch('{% url "zkteco:test_connections" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                device_ids: [{{ device.id|default:0 }}],
                test_data: {
                    ip: ip,
                    port: parseInt(port),
                    password: password
                }
            })
        })
        .then(response => response.json())
        .then(data => {
            loading.classList.add('hidden');
            loading.classList.remove('flex');
            
            if (data.success && data.results && data.results.length > 0) {
                const result = data.results[0];
                showConnectionResult(result.success, result.message, result.info);
            } else {
                showConnectionResult(false, data.error || 'Connection test failed');
            }
        })
        .catch(error => {
            loading.classList.add('hidden');
            loading.classList.remove('flex');
            showConnectionResult(false, 'Network error occurred');
            console.error('Error:', error);
        });
    }

    function showConnectionResult(success, message, info = null) {
        resultDiv.classList.remove('hidden');
        
        if (success) {
            resultIcon.className = 'flex items-center justify-center w-12 h-12 rounded-lg bg-green-100 text-green-600 dark:bg-green-900/20 dark:text-green-400';
            resultIcon.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
            resultTitle.textContent = 'Connection Successful';
            resultTitle.className = 'text-lg font-semibold text-green-600 dark:text-green-400';
            
            if (info) {
                resultDetails.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>Users: <span class="font-medium">${info.user_count || 0}</span></div>
                        <div>Records: <span class="font-medium">${info.attendance_count || 0}</span></div>
                    </div>
                `;
                resultDetails.classList.remove('hidden');
            }
        } else {
            resultIcon.className = 'flex items-center justify-center w-12 h-12 rounded-lg bg-red-100 text-red-600 dark:bg-red-900/20 dark:text-red-400';
            resultIcon.innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
            resultTitle.textContent = 'Connection Failed';
            resultTitle.className = 'text-lg font-semibold text-red-600 dark:text-red-400';
            resultDetails.classList.add('hidden');
        }
        
        resultMessage.textContent = message;
        
        // Auto-hide after 10 seconds
        setTimeout(() => {
            resultDiv.classList.add('hidden');
        }, 10000);
    }

    // IP address validation
    const ipInput = document.getElementById('{{ form.ip_address.id_for_label }}');
    if (ipInput) {
        ipInput.addEventListener('blur', function() {
            const ip = this.value;
            const ipPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            
            if (ip && !ipPattern.test(ip)) {
                this.classList.add('border-destructive');
                showToast('Please enter a valid IP address', 'error');
            } else {
                this.classList.remove('border-destructive');
            }
        });
    }

    // Port validation
    const portInput = document.getElementById('{{ form.port.id_for_label }}');
    if (portInput) {
        portInput.addEventListener('blur', function() {
            const port = parseInt(this.value);
            
            if (port && (port < 1 || port > 65535)) {
                this.classList.add('border-destructive');
                showToast('Port number must be between 1 and 65535', 'error');
            } else {
                this.classList.remove('border-destructive');
            }
        });
    }
});
</script>
{% endblock %}
