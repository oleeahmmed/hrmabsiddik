{% extends 'base.html' %}

{% block title %}Attendance Reports - {{ block.super }}{% endblock %}

{% block content %}
<div class="space-y-4 animate-fade-in-up">
  <!-- Compact Header -->
  <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
    <div>
      <h1 class="text-xl font-bold text-heading">Attendance Reports</h1>
      <p class="text-xs text-muted-foreground mt-0.5">Generate comprehensive attendance analytics and reports</p>
    </div>
    <div class="flex items-center gap-2">
      <a href="{% url 'zkteco:attendance_logs' %}" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-accent-foreground bg-accent hover:bg-accent/80 rounded-lg transition-all duration-200 focus-ring">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
        </svg>
        View Logs
      </a>
      <a href="{% url 'zkteco:device_list' %}" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-accent-foreground bg-accent hover:bg-accent/80 rounded-lg transition-all duration-200 focus-ring">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <rect width="18" height="11" x="3" y="11" rx="2" ry="2"></rect>
          <circle cx="12" cy="12" r="2"></circle>
        </svg>
        Devices
      </a>
    </div>
  </div>

  <!-- Report Type Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Daily Report Card -->
    <div class="glass-effect rounded-lg p-4 card-elevated animate-scale-in hover:shadow-lg transition-all duration-300 cursor-pointer" onclick="showReportForm('daily')">
      <div class="flex items-center justify-between mb-3">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect>
            <line x1="16" x2="16" y1="2" y2="6"></line>
            <line x1="8" x2="8" y1="2" y2="6"></line>
            <line x1="3" x2="21" y1="10" y2="10"></line>
          </svg>
        </div>
        <div class="text-xs font-medium text-primary bg-primary/10 px-2 py-1 rounded-full">Daily</div>
      </div>
      <h3 class="text-sm font-semibold text-heading mb-1">Daily Attendance Report</h3>
      <p class="text-xs text-muted-foreground mb-3 leading-relaxed">View detailed attendance records for a specific date with employee-wise breakdown</p>
      <div class="flex items-center gap-2 text-xs text-muted-foreground">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span>Generate Report</span>
      </div>
    </div>

    <!-- Monthly Report Card -->
    <div class="glass-effect rounded-lg p-4 card-elevated animate-scale-in hover:shadow-lg transition-all duration-300 cursor-pointer" onclick="showReportForm('monthly')">
      <div class="flex items-center justify-between mb-3">
        <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-lg flex items-center justify-center shadow-md">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M8 2v4m8-4v4M3 10h18M5 4h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V6a2 2 0 012-2z"></path>
          </svg>
        </div>
        <div class="text-xs font-medium text-emerald-600 bg-emerald-100 px-2 py-1 rounded-full">Monthly</div>
      </div>
      <h3 class="text-sm font-semibold text-heading mb-1">Monthly Attendance Report</h3>
      <p class="text-xs text-muted-foreground mb-3 leading-relaxed">Comprehensive monthly summary with attendance percentages and working hours</p>
      <div class="flex items-center gap-2 text-xs text-muted-foreground">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span>Generate Report</span>
      </div>
    </div>

    <!-- Analytics Report Card -->
    <div class="glass-effect rounded-lg p-4 card-elevated animate-scale-in hover:shadow-lg transition-all duration-300 cursor-pointer" onclick="showReportForm('analytics')">
      <div class="flex items-center justify-between mb-3">
        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path d="M3 3v18h18M9 17V9m4 8V5m4 12v-4"></path>
          </svg>
        </div>
        <div class="text-xs font-medium text-purple-600 bg-purple-100 px-2 py-1 rounded-full">Analytics</div>
      </div>
      <h3 class="text-sm font-semibold text-heading mb-1">Analytics Summary Report</h3>
      <p class="text-xs text-muted-foreground mb-3 leading-relaxed">Advanced analytics with department trends, top performers, and insights</p>
      <div class="flex items-center gap-2 text-xs text-muted-foreground">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
        <span>Generate Report</span>
      </div>
    </div>
  </div>

  <!-- Report Generation Form -->
  <div id="reportForm" class="glass-effect rounded-lg card-elevated animate-slide-in-right hidden">
    <div class="px-4 py-3 border-b border-border">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div id="reportIcon" class="w-6 h-6 bg-primary rounded-md flex items-center justify-center">
            <svg class="w-3 h-3 text-primary-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          <div>
            <h3 id="reportTitle" class="text-sm font-semibold text-heading">Generate Report</h3>
            <p id="reportDescription" class="text-xs text-muted-foreground">Configure your report parameters</p>
          </div>
        </div>
        <button onclick="hideReportForm()" class="text-muted-foreground hover:text-foreground transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    
    <div class="p-4">
      <form id="reportGenerationForm" class="space-y-4">
        <!-- Date Selection -->
        <div id="dateSelection" class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="space-y-1">
            <label class="block text-xs font-medium text-foreground uppercase tracking-wide">Start Date</label>
            <input type="date" name="start_date" value="{{ default_start_date }}" 
                   class="w-full px-3 py-2 text-xs bg-input border border-border rounded-md text-foreground focus:border-ring focus:ring-1 focus:ring-ring/20 focus:outline-none transition-all duration-200">
          </div>
          <div class="space-y-1">
            <label class="block text-xs font-medium text-foreground uppercase tracking-wide">End Date</label>
            <input type="date" name="end_date" value="{{ default_end_date }}" 
                   class="w-full px-3 py-2 text-xs bg-input border border-border rounded-md text-foreground focus:border-ring focus:ring-1 focus:ring-ring/20 focus:outline-none transition-all duration-200">
          </div>
        </div>

        <!-- Single Date for Daily Report -->
        <div id="singleDateSelection" class="hidden">
          <div class="space-y-1">
            <label class="block text-xs font-medium text-foreground uppercase tracking-wide">Report Date</label>
            <input type="date" name="date" value="{{ default_end_date }}" 
                   class="w-full px-3 py-2 text-xs bg-input border border-border rounded-md text-foreground focus:border-ring focus:ring-1 focus:ring-ring/20 focus:outline-none transition-all duration-200">
          </div>
        </div>

        <!-- Department Filter -->
        <div class="space-y-1">
          <label class="block text-xs font-medium text-foreground uppercase tracking-wide">Department</label>
          <select name="department" class="w-full px-3 py-2 text-xs bg-input border border-border rounded-md text-foreground focus:border-ring focus:ring-1 focus:ring-ring/20 focus:outline-none transition-all duration-200">
            <option value="">All Departments</option>
            {% for department in departments %}
            <option value="{{ department.id }}">{{ department.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-2 pt-2 border-t border-border">
          <button type="button" onclick="generateReport()" class="inline-flex items-center gap-1.5 px-4 py-2 text-xs font-medium bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-all duration-200 shadow-md hover:shadow-lg focus-ring">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Generate Report
          </button>
          
          <button type="button" onclick="hideReportForm()" class="inline-flex items-center gap-1.5 px-4 py-2 text-xs font-medium text-accent-foreground bg-accent hover:bg-accent/80 rounded-lg transition-all duration-200 focus-ring">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Report Results -->
  <div id="reportResults" class="glass-effect rounded-lg card-elevated hidden">
    <div class="px-4 py-3 border-b border-border">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-6 h-6 bg-gradient-to-br from-green-500 to-green-600 rounded-md flex items-center justify-center">
            <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <div>
            <h3 id="resultsTitle" class="text-sm font-semibold text-heading">Report Results</h3>
            <p id="resultsSubtitle" class="text-xs text-muted-foreground">Generated successfully</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="exportReport()" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-accent-foreground bg-accent hover:bg-accent/80 rounded-lg transition-all duration-200 focus-ring">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Export
          </button>
          <button onclick="hideReportResults()" class="text-muted-foreground hover:text-foreground transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Summary Cards -->
    <div id="summaryCards" class="p-4 border-b border-border hidden">
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
        <div class="bg-muted/30 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-0.5">Total Employees</p>
              <p id="totalEmployees" class="text-lg font-bold text-foreground">-</p>
            </div>
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center shadow-md">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-muted/30 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-0.5">Present</p>
              <p id="presentCount" class="text-lg font-bold text-green-600">-</p>
            </div>
            <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-lg flex items-center justify-center shadow-md">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-muted/30 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-0.5">Absent</p>
              <p id="absentCount" class="text-lg font-bold text-red-600">-</p>
            </div>
            <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-red-600 rounded-lg flex items-center justify-center shadow-md">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-muted/30 rounded-lg p-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs font-medium text-muted-foreground uppercase tracking-wide mb-0.5">Total Hours</p>
              <p id="totalHours" class="text-lg font-bold text-foreground">-</p>
            </div>
            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg flex items-center justify-center shadow-md">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12,6 12,12 16,14"></polyline>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Report Data Table -->
    <div id="reportTable" class="overflow-x-auto">
      <!-- Table content will be populated by JavaScript -->
    </div>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="glass-effect rounded-lg card-elevated p-8 text-center hidden">
    <div class="inline-flex items-center justify-center w-16 h-16 mx-auto mb-4 bg-primary/10 rounded-full">
      <svg class="w-8 h-8 text-primary animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>
    <h3 class="text-lg font-bold text-heading mb-2">Generating Report</h3>
    <p class="text-muted-foreground">Please wait while we process your request...</p>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentReportType = '';
let currentReportData = null;

function showReportForm(reportType) {
  currentReportType = reportType;
  const form = document.getElementById('reportForm');
  const title = document.getElementById('reportTitle');
  const description = document.getElementById('reportDescription');
  const icon = document.getElementById('reportIcon');
  const dateSelection = document.getElementById('dateSelection');
  const singleDateSelection = document.getElementById('singleDateSelection');
  
  // Update form based on report type
  switch(reportType) {
    case 'daily':
      title.textContent = 'Daily Attendance Report';
      description.textContent = 'Generate report for a specific date';
      icon.className = 'w-6 h-6 bg-gradient-to-br from-blue-500 to-blue-600 rounded-md flex items-center justify-center';
      dateSelection.classList.add('hidden');
      singleDateSelection.classList.remove('hidden');
      break;
    case 'monthly':
      title.textContent = 'Monthly Attendance Report';
      description.textContent = 'Generate report for a date range';
      icon.className = 'w-6 h-6 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-md flex items-center justify-center';
      dateSelection.classList.remove('hidden');
      singleDateSelection.classList.add('hidden');
      break;
    case 'analytics':
      title.textContent = 'Analytics Summary Report';
      description.textContent = 'Generate advanced analytics report';
      icon.className = 'w-6 h-6 bg-gradient-to-br from-purple-500 to-purple-600 rounded-md flex items-center justify-center';
      dateSelection.classList.remove('hidden');
      singleDateSelection.classList.add('hidden');
      break;
  }
  
  form.classList.remove('hidden');
  form.scrollIntoView({ behavior: 'smooth' });
}

function hideReportForm() {
  document.getElementById('reportForm').classList.add('hidden');
}

function hideReportResults() {
  document.getElementById('reportResults').classList.add('hidden');
}

async function generateReport() {
  const form = document.getElementById('reportGenerationForm');
  const formData = new FormData(form);
  const loadingState = document.getElementById('loadingState');
  const reportResults = document.getElementById('reportResults');
  
  // Show loading state
  hideReportForm();
  hideReportResults();
  loadingState.classList.remove('hidden');
  
  try {
    let url = '';
    let params = new URLSearchParams();
    
    // Add department filter if selected
    if (formData.get('department')) {
      params.append('department', formData.get('department'));
    }
    
    // Build URL based on report type
    switch(currentReportType) {
      case 'daily':
        url = '{% url "zkteco:daily_attendance_report" %}';
        params.append('date', formData.get('date'));
        break;
      case 'monthly':
        url = '{% url "zkteco:monthly_attendance_report" %}';
        params.append('start_date', formData.get('start_date'));
        params.append('end_date', formData.get('end_date'));
        break;
      case 'analytics':
        url = '{% url "zkteco:analytics_summary_report" %}';
        params.append('start_date', formData.get('start_date'));
        params.append('end_date', formData.get('end_date'));
        break;
    }
    
    const response = await fetch(`${url}?${params}`);
    const data = await response.json();
    
    if (data.success) {
      currentReportData = data;
      displayReportResults(data);
    } else {
      throw new Error(data.error || 'Failed to generate report');
    }
  } catch (error) {
    console.error('Error generating report:', error);
    alert('Error generating report: ' + error.message);
  } finally {
    loadingState.classList.add('hidden');
  }
}

function displayReportResults(data) {
  const resultsContainer = document.getElementById('reportResults');
  const resultsTitle = document.getElementById('resultsTitle');
  const resultsSubtitle = document.getElementById('resultsSubtitle');
  const summaryCards = document.getElementById('summaryCards');
  const reportTable = document.getElementById('reportTable');
  
  // Update title and subtitle
  resultsTitle.textContent = data.report_title || 'Report Results';
  resultsSubtitle.textContent = `Generated on ${new Date().toLocaleString()}`;
  
  // Update summary cards
  if (data.summary) {
    document.getElementById('totalEmployees').textContent = data.summary.total_employees || '-';
    document.getElementById('presentCount').textContent = data.summary.present || '-';
    document.getElementById('absentCount').textContent = data.summary.absent || '-';
    document.getElementById('totalHours').textContent = (data.summary.total_work_hours || 0) + 'h';
    summaryCards.classList.remove('hidden');
  }
  
  // Generate table based on report type
  let tableHTML = '';
  if (currentReportType === 'daily') {
    tableHTML = generateDailyReportTable(data.report_data);
  } else if (currentReportType === 'monthly') {
    tableHTML = generateMonthlyReportTable(data.report_data);
  } else if (currentReportType === 'analytics') {
    tableHTML = generateAnalyticsReportTable(data);
  }
  
  reportTable.innerHTML = tableHTML;
  resultsContainer.classList.remove('hidden');
  resultsContainer.scrollIntoView({ behavior: 'smooth' });
}

function generateDailyReportTable(reportData) {
  if (!reportData || reportData.length === 0) {
    return '<div class="p-8 text-center text-muted-foreground">No data available</div>';
  }
  
  let html = `
    <table class="min-w-full">
      <thead class="bg-muted/50">
        <tr class="border-b border-border">
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Employee</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Department</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Check In</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Check Out</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Status</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Work Hours</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Overtime</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-border">
  `;
  
  reportData.forEach(row => {
    const statusClass = row.status === 'Present' ? 'text-green-600 bg-green-100' : 
                       row.status === 'Absent' ? 'text-red-600 bg-red-100' : 
                       'text-yellow-600 bg-yellow-100';
    
    html += `
      <tr class="hover:bg-accent/30 transition-all duration-200">
        <td class="px-4 py-3">
          <div class="font-medium text-foreground text-xs">${row.employee_name}</div>
          <div class="text-xs text-muted-foreground font-mono">ID: ${row.employee_id}</div>
        </td>
        <td class="px-4 py-3 text-xs text-foreground">${row.department}</td>
        <td class="px-4 py-3 text-xs text-foreground font-mono">${row.check_in}</td>
        <td class="px-4 py-3 text-xs text-foreground font-mono">${row.check_out}</td>
        <td class="px-4 py-3">
          <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
            ${row.status}
          </span>
        </td>
        <td class="px-4 py-3 text-xs text-foreground font-mono">${row.work_hours}h</td>
        <td class="px-4 py-3 text-xs text-foreground font-mono">${row.overtime_hours}h</td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  return html;
}

function generateMonthlyReportTable(reportData) {
  if (!reportData || reportData.length === 0) {
    return '<div class="p-8 text-center text-muted-foreground">No data available</div>';
  }
  
  let html = `
    <table class="min-w-full">
      <thead class="bg-muted/50">
        <tr class="border-b border-border">
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Employee</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Department</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Present Days</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Absent Days</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Leave Days</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Total Hours</th>
          <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Attendance %</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-border">
  `;
  
  reportData.forEach(row => {
    const attendanceClass = row.attendance_percentage >= 90 ? 'text-green-600' : 
                           row.attendance_percentage >= 75 ? 'text-yellow-600' : 'text-red-600';
    
    html += `
      <tr class="hover:bg-accent/30 transition-all duration-200">
        <td class="px-4 py-3">
          <div class="font-medium text-foreground text-xs">${row.employee_name}</div>
          <div class="text-xs text-muted-foreground font-mono">ID: ${row.employee_id}</div>
        </td>
        <td class="px-4 py-3 text-xs text-foreground">${row.department}</td>
        <td class="px-4 py-3 text-xs text-foreground font-mono">${row.present_days}</td>
        <td class="px-4 py-3 text-xs text-foreground font-mono">${row.absent_days}</td>
        <td class="px-4 py-3 text-xs text-foreground font-mono">${row.leave_days}</td>
        <td class="px-4 py-3 text-xs text-foreground font-mono">${row.total_work_hours}h</td>
        <td class="px-4 py-3">
          <span class="text-xs font-medium ${attendanceClass}">${row.attendance_percentage}%</span>
        </td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  return html;
}

function generateAnalyticsReportTable(data) {
  if (!data.department_data || data.department_data.length === 0) {
    return '<div class="p-8 text-center text-muted-foreground">No data available</div>';
  }
  
  let html = `
    <div class="p-4">
      <h4 class="text-sm font-semibold text-heading mb-3">Department-wise Analysis</h4>
      <table class="min-w-full">
        <thead class="bg-muted/50">
          <tr class="border-b border-border">
            <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Department</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Employees</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Present</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Absent</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Attendance Rate</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-foreground uppercase tracking-wide">Total Hours</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
  `;
  
  data.department_data.forEach(dept => {
    const rateClass = dept.attendance_rate >= 90 ? 'text-green-600' : 
                     dept.attendance_rate >= 75 ? 'text-yellow-600' : 'text-red-600';
    
    html += `
      <tr class="hover:bg-accent/30 transition-all duration-200">
        <td class="px-4 py-3 text-xs font-medium text-foreground">${dept.department}</td>
        <td class="px-4 py-3 text-xs text-foreground">${dept.total_employees}</td>
        <td class="px-4 py-3 text-xs text-foreground">${dept.present_count}</td>
        <td class="px-4 py-3 text-xs text-foreground">${dept.absent_count}</td>
        <td class="px-4 py-3">
          <span class="text-xs font-medium ${rateClass}">${dept.attendance_rate}%</span>
        </td>
        <td class="px-4 py-3 text-xs text-foreground">${dept.total_work_hours}h</td>
      </tr>
    `;
  });
  
  html += '</tbody></table></div>';
  
  // Add top performers section
  if (data.top_performers && data.top_performers.length > 0) {
    html += `
      <div class="p-4 border-t border-border">
        <h4 class="text-sm font-semibold text-heading mb-3">Top Performers</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
    `;
    
    data.top_performers.slice(0, 6).forEach(performer => {
      html += `
        <div class="bg-muted/30 rounded-lg p-3">
          <div class="font-medium text-foreground text-xs">${performer.employee_name}</div>
          <div class="text-xs text-muted-foreground">${performer.department}</div>
          <div class="text-xs font-medium text-green-600 mt-1">${performer.attendance_rate}% attendance</div>
        </div>
      `;
    });
    
    html += '</div></div>';
  }
  
  return html;
}

function exportReport() {
  if (!currentReportData) {
    alert('No report data to export');
    return;
  }
  
  // Convert report data to CSV
  let csvContent = '';
  let filename = '';
  
  if (currentReportType === 'daily') {
    filename = `daily_attendance_${currentReportData.report_date}.csv`;
    csvContent = 'Employee ID,Employee Name,Department,Check In,Check Out,Status,Work Hours,Overtime Hours\n';
    currentReportData.report_data.forEach(row => {
      csvContent += `"${row.employee_id}","${row.employee_name}","${row.department}","${row.check_in}","${row.check_out}","${row.status}","${row.work_hours}","${row.overtime_hours}"\n`;
    });
  } else if (currentReportType === 'monthly') {
    filename = `monthly_attendance_${currentReportData.start_date}_to_${currentReportData.end_date}.csv`;
    csvContent = 'Employee ID,Employee Name,Department,Present Days,Absent Days,Leave Days,Total Hours,Attendance %\n';
    currentReportData.report_data.forEach(row => {
      csvContent += `"${row.employee_id}","${row.employee_name}","${row.department}","${row.present_days}","${row.absent_days}","${row.leave_days}","${row.total_work_hours}","${row.attendance_percentage}"\n`;
    });
  } else if (currentReportType === 'analytics') {
    filename = `analytics_summary_${currentReportData.start_date}_to_${currentReportData.end_date}.csv`;
    csvContent = 'Department,Total Employees,Present Count,Absent Count,Attendance Rate,Total Hours\n';
    currentReportData.department_data.forEach(dept => {
      csvContent += `"${dept.department}","${dept.total_employees}","${dept.present_count}","${dept.absent_count}","${dept.attendance_rate}","${dept.total_work_hours}"\n`;
    });
  }
  
  // Create and download file
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  // Add keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      hideReportForm();
      hideReportResults();
    }
  });
});
</script>
{% endblock %}
